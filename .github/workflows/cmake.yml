name: CMake

on: [push, workflow_dispatch]

env:
  BUILD_TYPE: Release
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  macos-universal-build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false  # avoid recursive checkout (Gem causes 500 errors)

      - name: Init required submodules only
        shell: bash
        run: |
          git submodule update --init plugdata
          git -C plugdata submodule update --init Libraries/JUCE

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: macos

      - name: Build plugins
        run: |
          set -euxo pipefail
          python3 ./build.py --compiler-launcher ccache

          # Inspect what was produced
          echo "== Workspace content =="
          ls -la
          echo "== Build tree (top 3 levels) =="
          find . -maxdepth 3 -type d -print

          # Collect outputs into a predictable folder
          mkdir -p Build-macOS-Universal

          # Copy common macOS bundles if they exist
          find . -type d \( -name "*.app" -o -name "*.vst3" -o -name "*.component" -o -name "*.clap" -o -name "*.lv2" \) -print \
            -exec cp -R {} Build-macOS-Universal/ \; || true

          # If the exporter produced a generic Build folder, include it
          if [ -d Build ]; then
            echo "Found generic Build/, moving to Build-macOS-Universal/"
            mv Build/* Build-macOS-Universal/ || true
          fi

          echo "== Staged artifacts =="
          find Build-macOS-Universal -maxdepth 2 -print || true

      - name: Archive Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Build-macOS-Universal
          path: Build-macOS-Universal/**
          if-no-files-found: warn
          compression-level: 0

  windows-64-build:
    runs-on: windows-2022

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Init required submodules only
        shell: bash
        run: |
          git submodule update --init plugdata
          git -C plugdata submodule update --init Libraries/JUCE

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: win64

      - name: Set up MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Install Ninja
        uses: seanmiddleditch/gha-setup-ninja@v3

      - name: Build plugins
        shell: bash
        run: |
          set -euxo pipefail
          python3 ./build.py --compiler-launcher ccache
          mkdir -p Build-Win64
          # Collect common Windows plugin bundles (if any specific structure exists, adjust here)
          if [ -d Build ]; then
            mv Build/* Build-Win64/ || true
          fi
          echo "== Staged artifacts (Win64) =="
          find Build-Win64 -maxdepth 2 -print || true

      - name: Archive Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Build-Win64
          path: Build-Win64/**
          if-no-files-found: warn

  windows-32-build:
    runs-on: windows-2022

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Init required submodules only
        shell: bash
        run: |
          git submodule update --init plugdata
          git -C plugdata submodule update --init Libraries/JUCE

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: win32

      - name: Set up MSVC environment
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: Win32

      - name: Install Ninja
        uses: seanmiddleditch/gha-setup-ninja@v3

      - name: Build plugins
        shell: bash
        run: |
          set -euxo pipefail
          python3 ./build.py --compiler-launcher ccache
          mkdir -p Build-Win32
          if [ -d Build ]; then
            mv Build/* Build-Win32/ || true
          fi
          echo "== Staged artifacts (Win32) =="
          find Build-Win32 -maxdepth 2 -print || true

      - name: Archive Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Build-Win32
          path: Build-Win32/**
          if-no-files-found: warn

  linux-x64-build:
    name: ${{ matrix.name }}
    runs-on: ubuntu-latest
    container:
      image: ${{ matrix.os }}
      options: --privileged
      volumes:
        - /sys/fs/cgroup:/sys/fs/cgroup

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Ubuntu-22.04-x64
            os: ubuntu:22.04
            pacman: apt
          - name: Ubuntu-24.04-x64
            os: ubuntu:24.04
            pacman: apt
          - name: Debian-x64
            os: debian
            pacman: apt
          - name: Fedora-41-x64
            os: fedora:41
            pacman: dnf
          - name: Fedora-42-x64
            os: fedora:42
            pacman: dnf
          - name: OpenSUSE-Tumbleweed-x64
            os: opensuse/tumbleweed
            pacman: zypper
          - name: Arch-x64
            os: archlinux
            pacman: pacman

    steps:
      - name: Install Dependencies (dnf)
        if: ${{ matrix.pacman == 'dnf' }}
        run: dnf install -y git cmake alsa-lib-devel libXinerama-devel freetype-devel curl libcurl-devel wget bzip2 gcc-c++ libXi-devel libXcomposite-devel freeglut-devel libXrandr-devel libXcursor-devel xz ccache python python3-pip jack-audio-connection-kit-devel libatomic unzip ninja-build

      - name: Install Dependencies (apt)
        if: ${{ matrix.pacman == 'apt' }}
        run: apt update && DEBIAN_FRONTEND=noninteractive TZ="Europe/Amsterdam" apt install -y cmake git wget bzip2 build-essential libasound2-dev libjack-jackd2-dev curl libcurl4-openssl-dev libfreetype6-dev libx11-dev libxi-dev libxcomposite-dev libxcursor-dev libxcursor-dev libxext-dev libxrandr-dev libxinerama-dev ccache python3 python3-pip freeglut3-dev unzip ninja-build

      - name: Install Dependencies (zypper)
        if: ${{ matrix.pacman == 'zypper' }}
        run: zypper refresh && zypper install -y git rsync wget bzip2 xz tar cmake alsa-devel libXinerama-devel libXi-devel libcurl-devel libXcomposite-devel freeglut-devel libXrandr-devel libXcursor-devel freetype2-devel gcc gcc-c++ curl ccache python3 libjack-devel gawk unzip ninja

      - name: Install Dependencies (pacman)
        if: ${{ matrix.pacman == 'pacman' }}
        run: pacman -Sy && pacman -S --noconfirm cmake wget bzip2 git alsa-lib freetype2 libx11 libxcursor libxi libxext libxinerama libxrandr libxrender webkit2gtk cmake make gcc pkgconf python python-pip curl ccache freeglut mesa glfw-x11 glew jack2 openssl unzip ninja && pacman --noconfirm -Syu

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Init required submodules only
        shell: bash
        run: |
          git submodule update --init plugdata
          git -C plugdata submodule update --init Libraries/JUCE

      - name: Update cmake
        working-directory: ${{ github.workspace }}
        run: ./.github/scripts/install-cmake.sh

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.name }}

      - name: Build plugins
        run: |
          set -euxo pipefail
          python3 ./build.py --compiler-launcher ccache
          mkdir -p Build-${{ matrix.name }}
          if [ -d Build ]; then
            mv Build/* Build-${{ matrix.name }}/ || true
          fi
          echo "== Staged artifacts (${ { matrix.name }} ) =="
          find Build-${{ matrix.name }} -maxdepth 2 -print || true

      - name: Archive Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Build-${{ matrix.name }}
          path: Build-${{ matrix.name }}/**
          if-no-files-found: warn

  linux-arm-build:
    name: ${{ matrix.name }}
    runs-on: ubuntu-24.04-arm
    container:
      image: ${{ matrix.os }}
      options: --privileged
      volumes:
        - /sys/fs/cgroup:/sys/fs/cgroup

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Ubuntu-22.04-aarch64
            os: ubuntu:22.04
            pacman: apt
          - name: Ubuntu-24.04-aarch64
            os: ubuntu:24.04
            pacman: apt
          - name: Debian-aarch64
            os: debian
            pacman: apt
          - name: Fedora-41-aarch64
            os: fedora:41
            pacman: dnf
          - name: Fedora-42-aarch64
            os: fedora:42
            pacman: dnf

    steps:
      - name: Install Dependencies (dnf)
        if: ${{ matrix.pacman == 'dnf' }}
        run: dnf install -y git cmake alsa-lib-devel libXinerama-devel freetype-devel curl libcurl-devel wget bzip2 gcc-c++ libXi-devel libXcomposite-devel freeglut-devel libXrandr-devel libXcursor-devel xz ccache python python3-pip jack-audio-connection-kit-devel libatomic unzip ninja-build

      - name: Install Dependencies (apt)
        if: ${{ matrix.pacman == 'apt' }}
        run: apt update && DEBIAN_FRONTEND=noninteractive TZ="Europe/Amsterdam" apt install -y cmake git wget bzip2 build-essential libasound2-dev libjack-jackd2-dev curl libcurl4-openssl-dev libfreetype6-dev libx11-dev libxi-dev libxcomposite-dev libxcursor-dev libxcursor-dev libxext-dev libxrandr-dev libxinerama-dev ccache python3 python3-pip freeglut3-dev unzip ninja-build

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Init required submodules only
        shell: bash
        run: |
          git submodule update --init plugdata
          git -C plugdata submodule update --init Libraries/JUCE

      - name: Update cmake
        working-directory: ${{ github.workspace }}
        run: ./.github/scripts/install-cmake.sh

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: ${{ matrix.name }}

      - name: Build plugins
        run: |
          set -euxo pipefail
          python3 ./build.py --compiler-launcher ccache
          mkdir -p Build-${{ matrix.name }}
          if [ -d Build ]; then
            mv Build/* Build-${{ matrix.name }}/ || true
          fi
          echo "== Staged artifacts (${ { matrix.name }} ) =="
          find Build-${{ matrix.name }} -maxdepth 2 -print || true

      - name: Archive Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Build-${{ matrix.name }}
          path: Build-${{ matrix.name }}/**
          if-no-files-found: warn
