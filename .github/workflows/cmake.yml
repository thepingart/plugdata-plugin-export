name: CMake

on: [push, workflow_dispatch]

env:
  BUILD_TYPE: Release
  CMAKE_BUILD_PARALLEL_LEVEL: 4

jobs:
  macos-universal-build:
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false  # avoid recursive checkout (Gem causes 500 errors)

      - name: Init submodules (sync, exclude Gem)
        shell: bash
        run: |
          set -euxo pipefail

          # Ensure the submodule points at *your fork* and URLs are up to date
          git submodule sync --recursive

          # Init top-level plugdata submodule
          git submodule update --init plugdata

          # Disable Gem (and its nested .git-ci) so CI never tries to hit git.iem.at
          git -C plugdata config submodule.Libraries/Gem.update none || true
          git -C plugdata config submodule.Libraries/Gem/.git-ci/iem-ci.update none || true

          # Recursively fetch ALL required libraries (fftw3, libwebp, xz, nanovg, melatonin_blur, JUCE, etc.)
          git -C plugdata submodule update --init --recursive --jobs 8 Libraries

          # Belt-and-suspenders: make sure JUCE is present
          git -C plugdata submodule update --init Libraries/JUCE

          # Show what we actually pulled (helps debug)
          git -C plugdata submodule status --recursive || true

      - name: ccache
        uses: hendrikmuhs/ccache-action@v1.2
        with:
          key: macos

      - name: Build plugins
        shell: bash
        run: |
          set -euxo pipefail
          # Run the build and capture a log
          python3 ./build.py --compiler-launcher ccache 2>&1 | tee build.log

          echo "== find top-level build dirs =="
          find . -maxdepth 2 -type d -name "Build*" -print || true

          # Stage artifacts (search widely to catch JUCE/plugdata output paths)
          mkdir -p Build-macOS-Universal

          echo "== searching for bundles =="
          find . -type d \( -name "*.app" -o -name "*.vst3" -o -name "*.component" -o -name "*.clap" -o -name "*.lv2" \) \
            -not -path "./.git/*" -print -exec cp -R "{}" Build-macOS-Universal/ \; || true

          # If a generic Build/ exists and is non-empty, copy its contents (use dot to preserve structure)
          if [ -d Build ] && [ -n "$(ls -A Build 2>/dev/null || true)" ]; then
            echo "Found generic Build/, copying contents to Build-macOS-Universal/"
            cp -R Build/. Build-macOS-Universal/ || true
          fi

          # Always keep the build log
          cp build.log Build-macOS-Universal/ || true

          echo "== staged contents =="
          find Build-macOS-Universal -maxdepth 2 -print || true

          # Hard fail if nothing was staged so we see the real cause in logs
          if [ -z "$(find Build-macOS-Universal -mindepth 1 -print -quit)" ]; then
            echo "No artifacts were staged. Last 200 lines of build.log:"
            tail -n 200 build.log || true
            exit 1
          fi

      - name: Archive Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: Build-macOS-Universal
          path: Build-macOS-Universal/**
          if-no-files-found: error
          compression-level: 0

  # windows-64-build:
  #   runs-on: windows-2022

  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #         submodules: false

  #     - name: Init submodules (sync, exclude Gem)
  #       shell: bash
  #       run: |
  #         set -euxo pipefail

  #         # Ensure the submodule points at *your fork* and URLs are up to date
  #         git submodule sync --recursive

  #         # Init top-level plugdata submodule
  #         git submodule update --init plugdata

  #         # Disable Gem (and its nested .git-ci) so CI never tries to hit git.iem.at
  #         git -C plugdata config submodule.Libraries/Gem.update none || true
  #         git -C plugdata config submodule.Libraries/Gem/.git-ci/iem-ci.update none || true

  #         # Recursively fetch ALL required libraries (fftw3, libwebp, xz, nanovg, melatonin_blur, JUCE, etc.)
  #         git -C plugdata submodule update --init --recursive --jobs 8 Libraries

  #         # Belt-and-suspenders: make sure JUCE is present
  #         git -C plugdata submodule update --init Libraries/JUCE

  #         # Show what we actually pulled (helps debug)
  #         git -C plugdata submodule status --recursive || true

  #     - name: ccache
  #       uses: hendrikmuhs/ccache-action@v1.2
  #       with:
  #         key: win64

  #     - name: Set up MSVC environment
  #       uses: ilammy/msvc-dev-cmd@v1
  #       with:
  #         arch: x64

  #     - name: Install Ninja
  #       uses: seanmiddleditch/gha-setup-ninja@v3

  #     - name: Build plugins
  #       shell: bash
  #       run: |
  #         set -euxo pipefail
  #         python3 ./build.py --compiler-launcher ccache 2>&1 | tee build.log

  #         mkdir -p Build-Win64

  #         # Collect common Windows plugin bundles or contents of Build/
  #         if [ -d Build ] && [ -n "$(ls -A Build 2>/dev/null || true)" ]; then
  #           cp -R Build/. Build-Win64/ || true
  #         fi

  #         cp build.log Build-Win64/ || true

  #         echo "== staged contents (Win64) =="
  #         find Build-Win64 -maxdepth 2 -print || true

  #         if [ -z "$(find Build-Win64 -mindepth 1 -print -quit)" ]; then
  #           echo "No artifacts were staged (Win64). Last 200 lines of build.log:"
  #           tail -n 200 build.log || true
  #           exit 1
  #         fi

  #     - name: Archive Artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: Build-Win64
  #         path: Build-Win64/**
  #         if-no-files-found: error

  # windows-32-build:
  #   runs-on: windows-2022

  #   steps:
  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #         submodules: false

  #     - name: Init submodules (sync, exclude Gem)
  #       shell: bash
  #       run: |
  #         set -euxo pipefail

  #         # Ensure the submodule points at *your fork* and URLs are up to date
  #         git submodule sync --recursive

  #         # Init top-level plugdata submodule
  #         git submodule update --init plugdata

  #         # Disable Gem (and its nested .git-ci) so CI never tries to hit git.iem.at
  #         git -C plugdata config submodule.Libraries/Gem.update none || true
  #         git -C plugdata config submodule.Libraries/Gem/.git-ci/iem-ci.update none || true

  #         # Recursively fetch ALL required libraries (fftw3, libwebp, xz, nanovg, melatonin_blur, JUCE, etc.)
  #         git -C plugdata submodule update --init --recursive --jobs 8 Libraries

  #         # Belt-and-suspenders: make sure JUCE is present
  #         git -C plugdata submodule update --init Libraries/JUCE

  #         # Show what we actually pulled (helps debug)
  #         git -C plugdata submodule status --recursive || true

  #     - name: ccache
  #       uses: hendrikmuhs/ccache-action@v1.2
  #       with:
  #         key: win32

  #     - name: Set up MSVC environment
  #       uses: ilammy/msvc-dev-cmd@v1
  #       with:
  #         arch: Win32

  #     - name: Install Ninja
  #       uses: seanmiddleditch/gha-setup-ninja@v3

  #     - name: Build plugins
  #       shell: bash
  #       run: |
  #         set -euxo pipefail
  #         python3 ./build.py --compiler-launcher ccache 2>&1 | tee build.log

  #         mkdir -p Build-Win32
  #         if [ -d Build ] && [ -n "$(ls -A Build 2>/dev/null || true)" ]; then
  #           cp -R Build/. Build-Win32/ || true
  #         fi
  #         cp build.log Build-Win32/ || true

  #         echo "== staged contents (Win32) =="
  #         find Build-Win32 -maxdepth 2 -print || true

  #         if [ -z "$(find Build-Win32 -mindepth 1 -print -quit)" ]; then
  #           echo "No artifacts were staged (Win32). Last 200 lines of build.log:"
  #           tail -n 200 build.log || true
  #           exit 1
  #         fi

  #     - name: Archive Artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: Build-Win32
  #         path: Build-Win32/**
  #         if-no-files-found: error

  # linux-x64-build:
  #   name: ${{ matrix.name }}
  #   runs-on: ubuntu-latest
  #   container:
  #     image: ${{ matrix.os }}
  #     options: --privileged
  #     volumes:
  #       - /sys/fs/cgroup:/sys/fs/cgroup

  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       include:
  #         - name: Ubuntu-22.04-x64
  #           os: ubuntu:22.04
  #           pacman: apt
  #         - name: Ubuntu-24.04-x64
  #           os: ubuntu:24.04
  #           pacman: apt
  #         - name: Debian-x64
  #           os: debian
  #           pacman: apt
  #         - name: Fedora-41-x64
  #           os: fedora:41
  #           pacman: dnf
  #         - name: Fedora-42-x64
  #           os: fedora:42
  #           pacman: dnf
  #         - name: OpenSUSE-Tumbleweed-x64
  #           os: opensuse/tumbleweed
  #           pacman: zypper
  #         - name: Arch-x64
  #           os: archlinux
  #           pacman: pacman

  #   steps:
  #     - name: Install Dependencies (dnf)
  #       if: ${{ matrix.pacman == 'dnf' }}
  #       run: dnf install -y git cmake alsa-lib-devel libXinerama-devel freetype-devel curl libcurl-devel wget bzip2 gcc-c++ libXi-devel libXcomposite-devel freeglut-devel libXrandr-devel libXcursor-devel xz ccache python python3-pip jack-audio-connection-kit-devel libatomic unzip ninja-build

  #     - name: Install Dependencies (apt)
  #       if: ${{ matrix.pacman == 'apt' }}
  #       run: apt update && DEBIAN_FRONTEND=noninteractive TZ="Europe/Amsterdam" apt install -y cmake git wget bzip2 build-essential libasound2-dev libjack-jackd2-dev curl libcurl4-openssl-dev libfreetype6-dev libx11-dev libxi-dev libxcomposite-dev libxcursor-dev libxcursor-dev libxext-dev libxrandr-dev libxinerama-dev ccache python3 python3-pip freeglut3-dev unzip ninja-build

  #     - name: Install Dependencies (zypper)
  #       if: ${{ matrix.pacman == 'zypper' }}
  #       run: zypper refresh && zypper install -y git rsync wget bzip2 xz tar cmake alsa-devel libXinerama-devel libXi-devel libcurl-devel libXcomposite-devel freeglut-devel libXrandr-devel libXcursor-devel freetype2-devel gcc gcc-c++ curl ccache python3 libjack-devel gawk unzip ninja

  #     - name: Install Dependencies (pacman)
  #       if: ${{ matrix.pacman == 'pacman' }}
  #       run: pacman -Sy && pacman -S --noconfirm cmake wget bzip2 git alsa-lib freetype2 libx11 libxcursor libxi libxext libxinerama libxrandr libxrender webkit2gtk cmake make gcc pkgconf python python-pip curl ccache freeglut mesa glfw-x11 glew jack2 openssl unzip ninja && pacman --noconfirm -Syu

  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #         submodules: false

  #     - name: Init required submodules only
  #       shell: bash
  #       run: |
  #         set -euxo pipefail
  #         git submodule update --init plugdata
  #         git -C plugdata submodule update --init Libraries/JUCE

  #     - name: Update cmake
  #       working-directory: ${{ github.workspace }}
  #       run: ./.github/scripts/install-cmake.sh

  #     - name: ccache
  #       uses: hendrikmuhs/ccache-action@v1.2
  #       with:
  #         key: ${{ matrix.name }}

  #     - name: Build plugins
  #       shell: bash
  #       run: |
  #         set -euxo pipefail
  #         python3 ./build.py --compiler-launcher ccache 2>&1 | tee build.log

  #         mkdir -p Build-${{ matrix.name }}
  #         if [ -d Build ] && [ -n "$(ls -A Build 2>/dev/null || true)" ]; then
  #           cp -R Build/. Build-${{ matrix.name }}/ || true
  #         fi
  #         cp build.log Build-${{ matrix.name }}/ || true

  #         echo "== staged contents (${{ matrix.name }}) =="
  #         find Build-${{ matrix.name }} -maxdepth 2 -print || true

  #         if [ -z "$(find Build-${{ matrix.name }} -mindepth 1 -print -quit)" ]; then
  #           echo "No artifacts were staged (${{ matrix.name }}). Last 200 lines of build.log:"
  #           tail -n 200 build.log || true
  #           exit 1
  #         fi

  #     - name: Archive Artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: Build-${{ matrix.name }}
  #         path: Build-${{ matrix.name }}/**
  #         if-no-files-found: error

  # linux-arm-build:
  #   name: ${{ matrix.name }}
  #   runs-on: ubuntu-24.04-arm
  #   container:
  #     image: ${{ matrix.os }}
  #     options: --privileged
  #     volumes:
  #       - /sys/fs/cgroup:/sys/fs/cgroup

  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       include:
  #         - name: Ubuntu-22.04-aarch64
  #           os: ubuntu:22.04
  #           pacman: apt
  #         - name: Ubuntu-24.04-aarch64
  #           os: ubuntu:24.04
  #           pacman: apt
  #         - name: Debian-aarch64
  #           os: debian
  #           pacman: apt
  #         - name: Fedora-41-aarch64
  #           os: fedora:41
  #           pacman: dnf
  #         - name: Fedora-42-aarch64
  #           os: fedora:42
  #           pacman: dnf

  #   steps:
  #     - name: Install Dependencies (dnf)
  #       if: ${{ matrix.pacman == 'dnf' }}
  #       run: dnf install -y git cmake alsa-lib-devel libXinerama-devel freetype-devel curl libcurl-devel wget bzip2 gcc-c++ libXi-devel libXcomposite-devel freeglut-devel libXrandr-devel libXcursor-devel xz ccache python python3-pip jack-audio-connection-kit-devel libatomic unzip ninja-build

  #     - name: Install Dependencies (apt)
  #       if: ${{ matrix.pacman == 'apt' }}
  #       run: apt update && DEBIAN_FRONTEND=noninteractive TZ="Europe/Amsterdam" apt install -y cmake git wget bzip2 build-essential libasound2-dev libjack-jackd2-dev curl libcurl4-openssl-dev libfreetype6-dev libx11-dev libxi-dev libxcomposite-dev libxcursor-dev libxcursor-dev libxext-dev libxrandr-dev libxinerama-dev ccache python3 python3-pip freeglut3-dev unzip ninja-build

  #     - uses: actions/checkout@v4
  #       with:
  #         fetch-depth: 0
  #         submodules: false

  #     - name: Init required submodules only
  #       shell: bash
  #       run: |
  #         set -euxo pipefail
  #         git submodule update --init plugdata
  #         git -C plugdata submodule update --init Libraries/JUCE

  #     - name: Update cmake
  #       working-directory: ${{ github.workspace }}
  #       run: ./.github/scripts/install-cmake.sh

  #     - name: ccache
  #       uses: hendrikmuhs/ccache-action@v1.2
  #       with:
  #         key: ${{ matrix.name }}

  #     - name: Build plugins
  #       shell: bash
  #       run: |
  #         set -euxo pipefail
  #         python3 ./build.py --compiler-launcher ccache 2>&1 | tee build.log

  #         mkdir -p Build-${{ matrix.name }}
  #         if [ -d Build ] && [ -n "$(ls -A Build 2>/dev/null || true)" ]; then
  #           cp -R Build/. Build-${{ matrix.name }}/ || true
  #         fi
  #         cp build.log Build-${{ matrix.name }}/ || true

  #         echo "== staged contents (${{ matrix.name }}) =="
  #         find Build-${{ matrix.name }} -maxdepth 2 -print || true

  #         if [ -z "$(find Build-${{ matrix.name }} -mindepth 1 -print -quit)" ]; then
  #           echo "No artifacts were staged (${{ matrix.name }}). Last 200 lines of build.log:"
  #           tail -n 200 build.log || true
  #           exit 1
  #         fi

  #     - name: Archive Artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: Build-${{ matrix.name }}
  #         path: Build-${{ matrix.name }}/**
  #         if-no-files-found: error
